#!/bin/bash


##############################################################################
##############################################################################
##
## this script reads in an env file that should have the following 
## exported environment variables:
##
##        STACK_NAME = the name of the stack to be deployed
##        REGION = the region to deploy the stack within
##
##############################################################################
##############################################################################


##############################################################################
##############################################################################
##
## MAGIC NUMBERS
##
##############################################################################
##############################################################################


ARG_NUMBER=1


##############################################################################
##############################################################################
##
## USAGE
##
##############################################################################
##############################################################################


usage(){
    if [ $# -lt $ARG_NUMBER ]; then
        echo "Usage: "
        echo "$0 \ "
        echo "  --env-file [ENV_FILE_PATH] \ "
        exit 1
    fi
}


##############################################################################
##############################################################################
##
## PARSE ARGS
##
##############################################################################
##############################################################################


parse_args(){
    while [[ $# > 1 ]];
    do
        key="$1"

        case $key in
            --env-file)
            ENV_FILE="$2"
            shift # past argument
            ;;
            *)
            # unknown option
            ;;
        esac
        shift
    done
}


##############################################################################
##############################################################################
##
## supporting functions
##
##############################################################################
##############################################################################


delete_stack(){
    echo "[-] $(date) - Deleting stack ... $STACK_NAME"
    aws cloudformation delete-stack \
        --stack-name $STACK_NAME \
        --region $REGION
}

wait_stack_delete(){
    echo "[-] $(date) - Waiting on stack delete ... $STACK_NAME"
    aws cloudformation wait stack-delete-complete \
        --stack-name $STACK_NAME \
        --region $REGION
}


##############################################################################
##############################################################################
##
## MAIN
##
##############################################################################
##############################################################################


main(){
    delete_stack
    wait_stack_delete
    echo "[+] $(date) - Stack teardown complete"   
}


usage $@
parse_args $@

source $ENV_FILE
main

